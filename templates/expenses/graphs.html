{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Графики потребления" %}{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center mb-5 fw-bold">{% trans "Потребление за последний год" %}</h1>

    <!-- ХОЛОДНАЯ ВОДА -->
    <div class="card shadow-lg mb-5 border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-primary text-white text-center py-4">
            <h3 class="mb-0">
                <i class="bi bi-droplet"></i> {% trans "Холодная вода" %}
            </h3>
        </div>
        <div class="card-body p-4 bg-light">
            <canvas id="chartColdWater" height="100"></canvas>
        </div>
        <div class="card-footer bg-white border-top-0">
            <div class="row text-center py-3">
                <div class="col border-end">
                    <small class="text-muted d-block">{% trans "Минимальный расход" %}</small>
                    <strong class="text-primary fs-4">{{ cold_stats.min|floatformat:2 }} м³</strong>
                </div>
                <div class="col border-end">
                    <small class="text-muted d-block">{% trans "Максимальный расход" %}</small>
                    <strong class="text-primary fs-4">{{ cold_stats.max|floatformat:2 }} м³</strong>
                </div>
                <div class="col">
                    <small class="text-muted d-block">{% trans "Среднее" %}</small>
                    <strong class="text-primary fs-4">{{ cold_stats.avg|floatformat:2 }} м³</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- ГОРЯЧАЯ ВОДА -->
    <div class="card shadow-lg mb-5 border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-danger text-white text-center py-4">
            <h3 class="mb-0">
                <i class="bi bi-droplet-fill"></i> {% trans "Горячая вода" %}
            </h3>
        </div>
        <div class="card-body p-4 bg-light">
            <canvas id="chartHotWater" height="100"></canvas>
        </div>
        <div class="card-footer bg-white border-top-0">
            <div class="row text-center py-3">
                <div class="col border-end">
                    <small class="text-muted d-block">{% trans "Мин" %}</small>
                    <strong class="text-danger fs-4">{{ hot_stats.min|floatformat:2 }} м³</strong>
                </div>
                <div class="col border-end">
                    <small class="text-muted d-block">{% trans "Макс" %}</small>
                    <strong class="text-danger fs-4">{{ hot_stats.max|floatformat:2 }} м³</strong>
                </div>
                <div class="col">
                    <small class="text-muted d-block">{% trans "Среднее" %}</small>
                    <strong class="text-danger fs-4">{{ hot_stats.avg|floatformat:2 }} м³</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- ЭЛЕКТРИЧЕСТВО -->
    <div class="card shadow-lg mb-5 border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-warning text-dark text-center py-4">
            <h3 class="mb-0">
                <i class="bi bi-lightning-charge"></i> {% trans "Электричество" %}
            </h3>
        </div>
        <div class="card-body p-4 bg-light">
            <canvas id="chartElectricity" height="100"></canvas>
        </div>
        <div class="card-footer bg-white border-top-0">
            <div class="row text-center py-3">
                <div class="col border-end">
                    <small class="text-muted d-block">{% trans "Мин" %}</small>
                    <strong class="text-warning fs-4">{{ electricity_stats.min|floatformat:1 }} kWh</strong>
                </div>
                <div class="col border-end">
                    <small class="text-muted d-block">{% trans "Макс" %}</small>
                    <strong class="text-warning fs-4">{{ electricity_stats.max|floatformat:1 }} kWh</strong>
                </div>
                <div class="col">
                    <small class="text-muted d-block">{% trans "Среднее" %}</small>
                    <strong class="text-warning fs-4">{{ electricity_stats.avg|floatformat:1 }} kWh</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ chart_data.labels|safe }};

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: ctx => {
                        if (ctx.parsed.y === null) return '— нет данных';
                        const unit = ctx.dataset.label.includes('вода') ? 'м³' : 'kWh';
                        return `${ctx.parsed.y.toFixed(2)} ${unit}`;
                    }
                }
            }
        },
        scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        }
    };

    new Chart(document.getElementById('chartColdWater'), {
        type: 'line',
        data: { labels, datasets: [{ data: {{ chart_data.cold_water|safe }}, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', tension: 0.4, pointRadius: 6, pointHoverRadius: 10, fill: true }] },
        options: commonOptions
    });

    new Chart(document.getElementById('chartHotWater'), {
        type: 'line',
        data: { labels, datasets: [{ data: {{ chart_data.hot_water|safe }}, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', tension: 0.4, pointRadius: 6, pointHoverRadius: 10, fill: true }] },
        options: commonOptions
    });

    new Chart(document.getElementById('chartElectricity'), {
        type: 'line',
        data: { labels, datasets: [{ data: {{ chart_data.electricity|safe }}, borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.1)', tension: 0.4, pointRadius: 6, pointHoverRadius: 10, fill: true }] },
        options: commonOptions
    });
</script>
{% endblock %}